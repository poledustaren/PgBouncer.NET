# PgBouncer.NET

–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π, –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—É–ª-–º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π PostgreSQL –Ω–∞ .NET 8, –∞–Ω–∞–ª–æ–≥ PgBouncer –¥–ª—è Windows.

## üöÄ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—É–ª—ã** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –ë–î/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –¥–æ 2000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **–¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –ø—É–ª–∏–Ω–≥–∞** - Session, Transaction, Statement
- **REST API** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTTP
- **–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ —Å 5 –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
- **–õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
pgbouncer.net/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ PgBouncer.Core/              # –Ø–¥—Ä–æ: –ø—Ä–æ—Ç–æ–∫–æ–ª, –ø—É–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ PgBouncer.Server/            # TCP –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ PgBouncer.Dashboard.Api/     # REST API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ PgBouncer.LoadTester/        # –£—Ç–∏–ª–∏—Ç–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–§–∞–π–ª `appsettings.json`:

```json
{
  "ListenPort": 6432,
  "DashboardPort": 5080,
  "Backend": {
    "Host": "127.0.0.1",
    "Port": 5437,
    "AdminUser": "postgres",
    "AdminPassword": "password"
  },
  "Pool": {
    "DefaultSize": 20,
    "MinSize": 2,
    "MaxSize": 100,
    "MaxTotalConnections": 2000,
    "Mode": "Transaction",
    "IdleTimeout": 300,
    "ConnectionTimeout": 30
  },
  "Auth": {
    "Type": "passthrough"
  }
}
```

## üèÉ –ó–∞–ø—É—Å–∫

### –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä

```powershell
cd src\PgBouncer.Server
dotnet run
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É `6432` (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `appsettings.json`).

### Dashboard API

```powershell
cd src\PgBouncer.Dashboard.Api
dotnet run
```

API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:5080` —Å Swagger UI.

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

–ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

```csharp
// –ë—ã–ª–æ:
Host=192.168.92.129;Port=5437;Database=fuel;...

// –°—Ç–∞–ª–æ:
Host=localhost;Port=6432;Database=fuel;...
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### REST API

- `GET /api/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –ø—É–ª–æ–≤
- `GET /api/stats/{database}/{username}` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—É–ª–∞
- `GET /api/stats/summary` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `POST /api/stats/reload` - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞

```powershell
curl http://localhost:5080/api/stats/summary
```

–û—Ç–≤–µ—Ç:

```json
{
  "totalPools": 3,
  "totalConnections": 45,
  "activeConnections": 12,
  "idleConnections": 33,
  "pools": [...]
}
```

## üß™ –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫

```powershell
cd tests\PgBouncer.LoadTester
dotnet run -- --connections 100 --instances 20 --pattern mixed --duration 60
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä        | –û–ø–∏—Å–∞–Ω–∏–µ                | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| --------------- | ----------------------- | ------------ |
| `--connections` | –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä | 100          |
| `--instances`   | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤  | 1            |
| `--pattern`     | –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–∞–≥—Ä—É–∑–∫–∏        | mixed        |
| `--duration`    | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)      | 60           |
| `--host`        | –•–æ—Å—Ç PgBouncer          | localhost    |
| `--port`        | –ü–æ—Ä—Ç PgBouncer          | 6432         |

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞–≥—Ä—É–∑–∫–∏

- **rapid** - –±—ã—Å—Ç—Ä—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (10ms –∑–∞–¥–µ—Ä–∂–∫–∞)
- **idle** - —Ä–µ–¥–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –º–Ω–æ–≥–æ idle –≤—Ä–µ–º–µ–Ω–∏ (5s –∑–∞–¥–µ—Ä–∂–∫–∞)
- **mixed** - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è active/idle (100-1000ms –∑–∞–¥–µ—Ä–∂–∫–∞)
- **burst** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –≤—Å–ø–ª–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **transaction** - –¥–ª–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:        60.12—Å
–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤:      125430
–ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫:        2086.24
–û—à–∏–±–æ–∫:              0 (0.00%)

Latency:
  –°—Ä–µ–¥–Ω—è—è:           12.45 –º—Å
  p50:               8.32 –º—Å
  p95:               28.91 –º—Å
  p99:               45.67 –º—Å
```

## üîß –†–µ–∂–∏–º—ã –ø—É–ª–∏–Ω–≥–∞

### Session Mode

–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ –≤—Å—ë –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏.

```json
"Pool": { "Mode": "Session" }
```

### Transaction Mode (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

```json
"Pool": { "Mode": "Transaction" }
```

### Statement Mode

–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ SQL statement.

```json
"Pool": { "Mode": "Statement" }
```

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –û–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –Ω–∞ –≤–µ—Å—å PostgreSQL —Å–µ—Ä–≤–µ—Ä

PgBouncer.NET –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç **–≤—Å–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –æ–¥–Ω–æ–º PostgreSQL —Å–µ—Ä–≤–µ—Ä–µ. –ü—É–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.

### –õ–∏–º–∏—Ç—ã

- `DefaultSize: 20` - –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ –Ω–∞ –ë–î/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `MaxSize: 100` - –º–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –ë–î/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `MaxTotalConnections: 2000` - –æ–±—â–∏–π –ª–∏–º–∏—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL

–î–ª—è 2000 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —É–≤–µ–ª–∏—á—å—Ç–µ `max_connections` –≤ `postgresql.conf`:

```
max_connections = 500
```

**–í–∞–∂–Ω–æ**: PgBouncer.NET –ø–æ–∑–≤–æ–ª—è–µ—Ç 2000 –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 100-200 —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –±–ª–∞–≥–æ–¥–∞—Ä—è transaction pooling.

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°–±–æ—Ä–∫–∞

```powershell
dotnet build
```

### –¢–µ—Å—Ç—ã

```powershell
dotnet test
```

## üìù TODO

- [ ] MD5 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- [ ] SCRAM-SHA-256 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- [ ] Prepared statements —Å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º
- [ ] –í–µ–±-–¥–∞—à–±–æ—Ä–¥ (Blazor)
- [ ] Windows Service wrapper
- [ ] Hot-reload –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ Prometheus

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## ü§ù –í–∫–ª–∞–¥

Pull requests –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è!

---

**–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –∏ –º–∞—Ç–∞–º–∏ –Ω–∞ .NET 8**
